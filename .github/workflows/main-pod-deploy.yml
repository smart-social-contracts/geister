name: Main Pod Deploy

on:
  workflow_dispatch:

jobs:
  deploy-main-pod:
    runs-on: ubuntu-latest
    env:
      RUNPOD_API_KEY: ${{ secrets.RUNPOD_API_KEY }}
      GEISTER_API_URL: https://geister-api.realmsgos.dev
      BOOTUP_TIMEOUT_SEC: 600

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install -e .

      - name: Deploy pod with latest image
        run: geister pod terminate && geister pod start --deploy-new --verbose

      - name: Wait for API to be ready
        run: ./scripts/health_check.py $BOOTUP_TIMEOUT_SEC "$GEISTER_API_URL"

      - name: Test API connectivity
        run: |
          echo "üîç Testing API connectivity..."
          geister status --check

      - name: Test basic ask functionality
        run: |
          echo "ü§ñ Testing basic ask..."
          geister agent generate 1
          geister agent ask 1 "Hello, are you working?" --api-url "$GEISTER_API_URL"

      - name: Test realm tool integration
        run: |
          echo "üèõÔ∏è Testing realm tool integration..."
          geister agent ask 1 "Please describe the realm at staging" --api-url "$GEISTER_API_URL"
